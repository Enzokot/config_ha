
  # Xiaomi Smartmi Air Humidifier 2

- alias: input number target humidity cb1 changed
  id: input number target humidity cb1 changed
  initial_state: true
  mode: queued
  max: 25
  trigger:
    - platform: state
      entity_id: input_number.zhimi_humidifier_cb1_target_humidity
  action:
    - service: humidifier.set_humidity
      data:
        entity_id: humidifier.zhimi_humidifier_cb1
        humidity: '{{ states("input_number.zhimi_humidifier_cb1_target_humidity") | int(0) }}'

- alias: sensor target humidity cb1 changed state
  id: sensor target humidity cb1 changed state
  initial_state: true
  mode: single
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: sensor.zhimi_humidifier_cb1_target_humidity
  condition:
    - condition: template
      value_template: >
        {% set ignore = ['unknown', 'unavailable', 'none', none, null] %}
        {{ trigger.to_state.state not in ignore and 
          trigger.to_state.state != trigger.from_state.state
        }}
  action:
    - service: input_number.set_value
      entity_id: input_number.zhimi_humidifier_cb1_target_humidity
      data:
        value: >-
                {% if trigger.to_state.state | int(0) != 0 -%}
                  {{ trigger.to_state.state | int(0) }}
                {%- else -%}
                  40
                {%- endif %}

- alias: input number target humidity ca4 changed
  id: input number target humidity ca4 changed
  initial_state: true
  mode: queued
  max: 25
  trigger:
    - platform: state
      entity_id: input_number.zhimi_humidifier_ca4_target_humidity
  action:
    - service: humidifier.set_humidity
      data:
        entity_id: humidifier.zhimi_humidifier_ca4
        humidity: '{{ states("input_number.zhimi_humidifier_ca4_target_humidity") | int(0) }}'

- alias: sensor target humidity ca4 changed state
  id: sensor target humidity ca4 changed state
  initial_state: true
  mode: single
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: sensor.zhimi_humidifier_ca4_target_humidity
  condition:
    - condition: template
      value_template: >
        {% set ignore = ['unknown', 'unavailable', 'none', none, null] %}
        {{ trigger.to_state.state not in ignore and 
          trigger.to_state.state != trigger.from_state.state
        }}
  action:
    - service: input_number.set_value
      entity_id: input_number.zhimi_humidifier_ca4_target_humidity
      data:
        value: >-
                {% if trigger.to_state.state | int(0) != 0 -%}
                  {{ trigger.to_state.state | int(0) }}
                {%- else -%}
                  40
                {%- endif %}

# #Увлажнитель на ночь 1 скорость, днем авто
- alias: air humidifier day and night speed
  id: air humidifier day and night speed
  #initial_state: true
  mode: queued
  max: 25
  trigger:
    - platform: time
      at: "22:00:00"
    - platform: time
      at: "08:00:00"
  action:
      - parallel:
          - choose:
              - conditions:  
                    - condition: state
                      entity_id: humidifier.zhimi_humidifier_cb1
                      state: 'on'    
                sequence:
                    - service: humidifier.set_mode
                      data:
                        entity_id: humidifier.zhimi_humidifier_cb1
                        speed: >-
                              {% if '08:00:00' <= as_timestamp(trigger.now, 0) | timestamp_custom('%H:%M:%S', true, 0)  < '22:00:00' %}
                                Auto
                              {% else %}  
                                Silent 
                              {% endif %}
          - choose:
              - conditions:  
                    - condition: state
                      entity_id: humidifier.zhimi_humidifier_ca4
                      state: 'on'    
                sequence:
                    - service: humidifier.set_mode
                      data:
                        entity_id: humidifier.zhimi_humidifier_ca4
                        speed: >-
                              {% if '08:00:00' <= as_timestamp(trigger.now, 0) | timestamp_custom('%H:%M:%S', true, 0)  < '22:00:00' %}
                                Auto
                              {% else %}  
                                Low 
                              {% endif %}

#Вкл/выкл климат. устройств при открытии/закрытии окна
- alias: turn on off climate devices childrens room window open close
  id: turn on off climate devices childrens room window open close
  mode: single
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: binary_sensor.window_childrens_room_group
      from: "off"
      to: "on"
      for: "00:05:00"
    - platform: state
      entity_id: binary_sensor.window_childrens_room_group
      from: "on"
      to: "off"
      for: "00:01:15"
  condition: >
              {{ 
                 trigger.to_state.state == 'on' or 
                 is_state('input_boolean.auto_triggered_fan_window_childrens_room', 'on') or is_state('input_boolean.auto_triggered_valve_window_childrens_room', 'on')
              }}
  action:
      - parallel:
          - sequence:
            - if:
                - "{{ states('humidifier.zhimi_humidifier_ca4') in ['unknown', 'unavailable'] }}"
              then:
                - wait_for_trigger:
                    - platform: state
                      entity_id: humidifier.zhimi_humidifier_ca4
                      from: 
                        - "unknown"
                        - "unavailable"
                  timeout: 75
            - choose:
                - conditions:
                      - condition: template
                        value_template: >
                          {{ 
                            trigger.to_state.state == 'on' and is_state('humidifier.zhimi_humidifier_ca4', 'on') 
                            or trigger.to_state.state == 'off' and is_state('humidifier.zhimi_humidifier_ca4', 'off')
                            and is_state('input_boolean.auto_triggered_fan_window_childrens_room', 'on')
                          }}
                  sequence:
                      - service: >
                                  {% if trigger.to_state.state == 'on' -%}
                                    humidifier.turn_off
                                  {%- else -%}
                                    humidifier.turn_on
                                  {%- endif %}
                        data:
                          entity_id: humidifier.zhimi_humidifier_ca4
                      - service: input_boolean.toggle
                        entity_id: input_boolean.auto_triggered_fan_window_childrens_room
                - conditions:
                      - condition: template
                        value_template: >
                          {{ 
                            trigger.to_state.state == 'off'
                            and is_state('input_boolean.auto_triggered_fan_window_childrens_room', 'on')
                          }}
                  sequence:
                      - service: input_boolean.turn_off
                        entity_id: input_boolean.auto_triggered_fan_window_childrens_room
          - choose:
              - conditions:
                    - condition: template
                      value_template: >
                        {{ 
                           trigger.to_state.state == 'on' and is_state('climate.0x5c0272fffec89454', 'auto') 
                           or trigger.to_state.state == 'off' and is_state('climate.0x5c0272fffec89454', 'off') 
                           and is_state('input_boolean.auto_triggered_valve_window_childrens_room', 'on')
                        }}
                sequence:
                    - service: climate.set_hvac_mode
                      data:
                        entity_id: climate.0x5c0272fffec89454
                        hvac_mode: >
                                {% if trigger.to_state.state == 'on' -%}
                                  off
                                {%- else -%}
                                  auto
                                {%- endif %}
                    - service: >
                                {% if trigger.to_state.state == 'off' -%}
                                  input_boolean.turn_off
                                {%- else -%}
                                  input_boolean.turn_on
                                {%- endif %}
                      entity_id: input_boolean.auto_triggered_valve_window_childrens_room
                    - service: climate.set_preset_mode
                      data:
                        entity_id: climate.0x5c0272fffec89454
                        preset_mode: manual
              - conditions:
                    - condition: template
                      value_template: >
                        {{ 
                           trigger.to_state.state == 'off' and is_state('climate.0x5c0272fffec89454', 'on') 
                           and is_state('input_boolean.auto_triggered_valve_window_childrens_room', 'on')
                        }}
                sequence:
                    - service: input_boolean.turn_off
                      entity_id: input_boolean.auto_triggered_valve_window_childrens_room

- alias: turn on off climate devices bed room window open close
  id: turn on off climate devices bed room window open close
  mode: single
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: binary_sensor.window_bed_room_group
      from: "off"
      to: "on"
      for: "00:05:00"
    - platform: state
      entity_id: binary_sensor.window_bed_room_group
      from: "on"
      to: "off"
      for: "00:01:15"
  condition: >
              {{ 
                 trigger.to_state.state == 'on' or 
                 is_state('input_boolean.auto_triggered_fan_window_bed_room', 'on') or is_state('input_boolean.auto_triggered_valve_window_bed_room', 'on')
              }}
  action:
      - parallel:
          - sequence:
            - if:
                - "{{ states('humidifier.zhimi_humidifier_cb1') in ['unknown', 'unavailable'] }}"
              then:
                - wait_for_trigger:
                    - platform: state
                      entity_id: humidifier.zhimi_humidifier_cb1
                      from: 
                        - "unknown"
                        - "unavailable"
                  timeout: 75
            - choose:
                - conditions:
                      - condition: template
                        value_template: >
                          {{ 
                            trigger.to_state.state == 'on' and is_state('humidifier.zhimi_humidifier_cb1', 'on') 
                            or trigger.to_state.state == 'off' and is_state('humidifier.zhimi_humidifier_cb1', 'off')
                            and is_state('input_boolean.auto_triggered_fan_window_bed_room', 'on')
                          }}
                  sequence:
                      - service: >
                                  {% if trigger.to_state.state == 'on' -%}
                                    humidifier.turn_off
                                  {%- else -%}
                                    humidifier.turn_on
                                  {%- endif %}
                        data:
                          entity_id: humidifier.zhimi_humidifier_cb1
                      - service: >
                                  {% if trigger.to_state.state == 'off' -%}
                                    input_boolean.turn_off
                                  {%- else -%}
                                    input_boolean.turn_on
                                  {%- endif %}
                        entity_id: input_boolean.auto_triggered_fan_window_bed_room
                - conditions:
                      - condition: template
                        value_template: >
                          {{ 
                            trigger.to_state.state == 'off'
                            and is_state('input_boolean.auto_triggered_fan_window_bed_room', 'on')
                          }}
                  sequence:
                      - service: input_boolean.turn_off
                        entity_id: input_boolean.auto_triggered_fan_window_bed_room
          - choose:
              - conditions:
                    - condition: template
                      value_template: >
                        {{ 
                           trigger.to_state.state == 'on' and is_state('climate.0x60a423fffe968719', 'auto') 
                           or trigger.to_state.state == 'off' and is_state('climate.0x60a423fffe968719', 'off') 
                           and is_state('input_boolean.auto_triggered_valve_window_bed_room', 'on')
                        }}
                sequence:
                    - service: climate.set_hvac_mode
                      data:
                        entity_id: climate.0x60a423fffe968719
                        hvac_mode: >
                                {% if trigger.to_state.state == 'on' -%}
                                  off
                                {%- else -%}
                                  auto
                                {%- endif %}
                    - service: >
                                {% if trigger.to_state.state == 'off' -%}
                                  input_boolean.turn_off
                                {%- else -%}
                                  input_boolean.turn_on
                                {%- endif %}
                      entity_id: input_boolean.auto_triggered_valve_window_bed_room
                    - service: climate.set_preset_mode
                      data:
                        entity_id: climate.0x60a423fffe968719
                        preset_mode: manual
              - conditions:
                    - condition: template
                      value_template: >
                        {{ 
                           trigger.to_state.state == 'off' and is_state('climate.0x60a423fffe968719', 'on') 
                           and is_state('input_boolean.auto_triggered_valve_window_bed_room', 'on')
                        }}
                sequence:
                    - service: input_boolean.turn_off
                      entity_id: input_boolean.auto_triggered_valve_window_bed_room

- alias: turn on off climate devices kitchen window open close
  id: turn on off climate devices kitchen window open close
  mode: single
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: binary_sensor.window_kitchen_group
      from: "off"
      to: "on"
      for: "00:05:00"
    - platform: state
      entity_id: binary_sensor.window_kitchen_group
      from: "on"
      to: "off"
      for: "00:01:15"
  condition: >
              {{ 
                 trigger.to_state.state == 'on' or is_state('input_boolean.auto_triggered_valve_window_kitchen', 'on')
              }}
  action:
      - choose:
          - conditions:  
                - condition: template
                  value_template: >
                    {{ 
                       trigger.to_state.state == 'on' and is_state('climate.0x5c0272fffe8de819', 'auto') 
                       or trigger.to_state.state == 'off' and is_state('climate.0x5c0272fffe8de819', 'off') 
                       and is_state('input_boolean.auto_triggered_valve_window_kitchen', 'on')
                    }}
            sequence:
                - service: climate.set_hvac_mode
                  data:
                    entity_id: climate.0x5c0272fffe8de819
                    hvac_mode: >
                            {% if trigger.to_state.state == 'on' -%}
                              off
                            {%- else -%}
                              auto
                            {%- endif %}
                - service: >
                            {% if trigger.to_state.state == 'off' -%}
                              input_boolean.turn_off
                            {%- else -%}
                              input_boolean.turn_on
                            {%- endif %}
                  entity_id: input_boolean.auto_triggered_valve_window_kitchen
                - service: climate.set_preset_mode
                  data:
                    entity_id: climate.0x5c0272fffe8de819
                    preset_mode: manual
          - conditions:  
                - condition: template
                  value_template: >
                    {{ 
                       trigger.to_state.state == 'off' and is_state('climate.0x5c0272fffe8de819', 'on') 
                       and is_state('input_boolean.auto_triggered_valve_window_kitchen', 'on')
                    }}
            sequence:
                - service: input_boolean.turn_off
                  entity_id: input_boolean.auto_triggered_valve_window_kitchen

- alias: turn on off climate devices living room window open close
  id: turn on off climate devices living room window open close
  mode: single
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: binary_sensor.window_living_room_group
      from: "off"
      to: "on"
      for: "00:05:00"
    - platform: state
      entity_id: binary_sensor.window_living_room_group
      from: "on"
      to: "off"
      for: "00:01:15"
  condition: >
              {{ 
                 trigger.to_state.state == 'on' or
                 is_state('input_boolean.auto_triggered_ac_window_living_room', 'on') or is_state('input_boolean.auto_triggered_valve_window_living_room', 'on')
              }}
  action:
      - choose:
          - conditions:  
                - condition: template
                  value_template: >
                    {{ 
                       trigger.to_state.state == 'on' and states('climate.avatto_living_room_ac') == 'cool'
                       or trigger.to_state.state == 'off' and is_state('climate.avatto_living_room_ac', 'off')
                       and is_state('input_boolean.auto_triggered_ac_window_living_room', 'on')
                    }}
            sequence:
                - service: climate.set_hvac_mode
                  data:
                    entity_id: climate.avatto_living_room_ac
                    hvac_mode: >
                            {% if trigger.to_state.state == 'on' -%}
                              off
                            {%- else -%}
                              cool
                            {%- endif %}
                - service: >
                            {% if trigger.to_state.state == 'off' -%}
                              input_boolean.turn_off
                            {%- else -%}
                              input_boolean.turn_on
                            {%- endif %}
                  entity_id: input_boolean.auto_triggered_ac_window_living_room
          - conditions:  
                - condition: template
                  value_template: >
                    {{ 
                       trigger.to_state.state == 'off' and states('climate.avatto_living_room_ac') == 'cool'
                       and is_state('input_boolean.auto_triggered_ac_window_living_room', 'on')
                    }}
            sequence:
                - service: input_boolean.turn_off
                  entity_id: input_boolean.auto_triggered_ac_window_living_room

      - choose:
          - conditions:  
                - condition: template
                  value_template: >
                    {{ 
                       trigger.to_state.state == 'on' and is_state('climate.0x5c0272fffec9db22', 'auto') 
                       or trigger.to_state.state == 'off' and is_state('climate.0x5c0272fffec9db22', 'off') 
                       and is_state('input_boolean.auto_triggered_valve_window_living_room', 'on')
                    }}
            sequence:
                - service: climate.set_hvac_mode
                  data:
                    entity_id: climate.0x5c0272fffec9db22
                    hvac_mode: >
                            {% if trigger.to_state.state == 'on' -%}
                              off
                            {%- else -%}
                              auto
                            {%- endif %}
                - service: >
                            {% if trigger.to_state.state == 'off' -%}
                              input_boolean.turn_off
                            {%- else -%}
                              input_boolean.turn_on
                            {%- endif %}
                  entity_id: input_boolean.auto_triggered_valve_window_living_room
                - service: climate.set_preset_mode
                  data:
                    entity_id: climate.0x5c0272fffec9db22
                    preset_mode: manual
          - conditions:  
                - condition: template
                  value_template: >
                    {{ 
                       trigger.to_state.state == 'off' and is_state('climate.0x5c0272fffec9db22', 'on') 
                       and is_state('input_boolean.auto_triggered_valve_window_living_room', 'on')
                    }}
            sequence:
                - service: input_boolean.turn_off
                  entity_id: input_boolean.auto_triggered_valve_window_living_room

#Перезапуск розетки для увлажнителя в спальне
- alias: restart socket 2 for bedroom air humidifier unavailable
  id: restart socket 2 for bedroom air humidifier unavailable
  initial_state: true
  mode: single
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: humidifier.zhimi_humidifier_cb1
      to: 'unavailable'
    - platform: homeassistant
      event: start
  condition:
    - condition: state
      entity_id: humidifier.zhimi_humidifier_cb1
      state: 'unavailable'
    - condition: state
      entity_id: switch.0x60a423fffef8d41a
      state: 'on'
  action:
    - wait_for_trigger:
        - platform: state
          entity_id: humidifier.zhimi_humidifier_cb1
          from: 'unavailable'
      timeout: "00:05:00"
    - choose:
        - conditions: "{{ wait.trigger == None and is_state('binary_sensor.local_network_availability', 'on') }}"
          sequence:
              - service: switch.turn_off
                data:
                  entity_id: switch.0x60a423fffef8d41a
              - delay:
                  seconds: 5
              - service: switch.turn_on
                data:
                  entity_id: switch.0x60a423fffef8d41a
